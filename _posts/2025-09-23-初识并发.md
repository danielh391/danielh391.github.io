---
layout:     post
title:      åˆè¯†å¹¶å‘
subtitle:   
date:       2025-09-23
author:     danielh
header-img: img/post-bg-rwd.jpg
catalog: true
tags:
    - å¹¶å‘


---
å¥½çš„ï¼ŒC++ å®ç°å¹¶å‘ä¸»è¦ä¾èµ–äºæ ‡å‡†åº“ä¸­çš„ **`<thread>`** åº“ï¼ˆC++11 å¼•å…¥ï¼‰ã€‚æˆ‘å°†ä»ç®€å•åˆ°å¤æ‚ï¼Œç”¨ç”ŸåŠ¨çš„ä¾‹å­å¸¦ä½ ç†è§£å¦‚ä½•å®ç°ã€‚

### æ ¸å¿ƒæ¦‚å¿µï¼šstd::thread

`std::thread` æ˜¯ C++ ä¸­è¡¨ç¤ºå•ä¸ªæ‰§è¡Œçº¿ç¨‹çš„ç±»ã€‚åˆ›å»ºä¸€ä¸ª `thread` å¯¹è±¡å°±ç›¸å½“äºå‘Šè¯‰æ“ä½œç³»ç»Ÿï¼šâ€œå»å¼€è¾Ÿä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œæ‰§è¡Œæˆ‘æŒ‡å®šçš„ä»»åŠ¡ï¼â€

---

### ç¤ºä¾‹ 1ï¼šæœ€ç®€å•çš„å¹¶å‘ - åˆ›å»ºçº¿ç¨‹

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ ä¸€è¾¹åœ¨å¬éŸ³ä¹ï¼ˆä»»åŠ¡Aï¼‰ï¼Œä¸€è¾¹åœ¨å†™æ–‡æ¡£ï¼ˆä»»åŠ¡Bï¼‰ã€‚è¿™ä¸¤ä¸ªä»»åŠ¡å°±æ˜¯å¹¶å‘æ‰§è¡Œçš„ã€‚

```cpp
#include <iostream>
#include <thread> // åŒ…å«çº¿ç¨‹åº“
#include <chrono> // ç”¨äºæ—¶é—´æ“ä½œ

// ä»»åŠ¡Aï¼šæ¨¡æ‹Ÿâ€œå¬éŸ³ä¹â€
void listenToMusic() {
    for (int i = 0; i < 5; ++i) {
        std::cout << "â™ª Listening to music... (" << i+1 << "/5)\n";
        std::this_thread::sleep_for(std::chrono::milliseconds(500)); // æš‚åœ500æ¯«ç§’ï¼Œæ¨¡æ‹Ÿè€—æ—¶
    }
}

// ä»»åŠ¡Bï¼šæ¨¡æ‹Ÿâ€œå†™æ–‡æ¡£â€
void writeDocument() {
    for (int i = 0; i < 5; ++i) {
        std::cout << "ğŸ“ Writing document... (" << i+1 << "/5)\n";
        std::this_thread::sleep_for(std::chrono::milliseconds(300)); // æš‚åœ300æ¯«ç§’
    }
}

int main() {
    std::cout << "ğŸš€ Main thread starts. Creating worker threads...\n";

    // åˆ›å»ºå¹¶å¯åŠ¨çº¿ç¨‹ï¼
    // thread_obj(å‡½æ•°å) 
    std::thread musicThread(listenToMusic); // å¼€è¾Ÿæ–°çº¿ç¨‹æ‰§è¡ŒlistenToMusic
    std::cout << "--> Music thread created!\n";
    std::thread docThread(writeDocument);   // å¼€è¾Ÿæ–°çº¿ç¨‹æ‰§è¡ŒwriteDocument
    std::cout << "--> Doc thread created!\n";

    // ç­‰å¾…çº¿ç¨‹ç»“æŸï¼
    // è¿™å°±åƒä½ å¿…é¡»ç­‰ä¸¤ä»¶äº‹éƒ½åšå®Œæ‰èƒ½å…³æœºã€‚
    // å¦‚æœä¸ç­‰å¾…ï¼Œä¸»çº¿ç¨‹ç»“æŸä¼šå¼ºåˆ¶ç»ˆæ­¢æ‰€æœ‰å­çº¿ç¨‹ã€‚
    musicThread.join();
    std::cout << "--> Music thread finished!\n";
    docThread.join();
    std::cout << "--> Doc thread finished!\n";

    std::cout << "âœ… All tasks done! Main thread ends.\n";
    return 0;
}
```

**è¾“å‡ºå¯èƒ½å¦‚ä¸‹ï¼ˆæ¯æ¬¡è¿è¡Œé¡ºåºå¯èƒ½ä¸åŒï¼Œè¿™æ­£æ˜¯å¹¶å‘çš„ç‰¹ç‚¹ï¼ï¼‰ï¼š**
```
ğŸš€ Main thread starts. Creating worker threads...
--> Music thread created!
--> Doc thread created!
ğŸ“ Writing document... (1/5)
â™ª Listening to music... (1/5)
ğŸ“ Writing document... (2/5)
â™ª Listening to music... (2/5)
ğŸ“ Writing document... (3/5)
â™ª Listening to music... (3/5)
ğŸ“ Writing document... (4/5)
ğŸ“ Writing document... (5/5)
â™ª Listening to music... (4/5)
â™ª Listening to music... (5/5)
--> Music thread finished!
--> Doc thread finished!
âœ… All tasks done! Main thread ends.
```

**å…³é”®ç‚¹ï¼š**
1.  `std::thread t(function_name)`: åˆ›å»ºçº¿ç¨‹å¹¶ç«‹å³å¼€å§‹æ‰§è¡Œã€‚
2.  `t.join()`: ä¸»çº¿ç¨‹é˜»å¡åœ¨è¿™é‡Œï¼Œç­‰å¾…çº¿ç¨‹ `t` æ‰§è¡Œå®Œæ¯•ã€‚**å¿…é¡»ç­‰å¾…ä½ åˆ›å»ºçš„æ‰€æœ‰çº¿ç¨‹**ï¼Œå¦åˆ™ä¸»å‡½æ•°é€€å‡ºä¼šå¯¼è‡´ç¨‹åºå´©æºƒã€‚
3.  è¾“å‡ºæ˜¯äº¤é”™æ··åˆçš„ï¼Œè¯æ˜ä¸¤ä¸ªå‡½æ•°ç¡®å®åœ¨**åŒæ—¶è¿è¡Œ**ã€‚

---

### ç¤ºä¾‹ 2ï¼šå¹¶å‘å¸¦æ¥çš„é—®é¢˜ - æ•°æ®ç«äº‰

ç°åœ¨ï¼Œå‡è®¾ä½ å’Œä½ çš„å®¤å‹å…±äº«ä¸€ä¸ªé“¶è¡Œè´¦æˆ·ï¼ˆå…±äº«æ•°æ®ï¼‰ï¼Œä½ ä»¬ä¿©åŒæ—¶å»å–é’±ï¼ˆå¹¶å‘æ“ä½œï¼‰ã€‚

```cpp
#include <iostream>
#include <thread>

int shared_account = 1000; // å…±äº«è´¦æˆ·ï¼Œåˆå§‹æœ‰1000å…ƒ

// ä»»åŠ¡ï¼šå–é’±
void withdrawMoney(int amount) {
    if (shared_account >= amount) {
        // æ¨¡æ‹Ÿä¸€ä¸ªè€—æ—¶çš„æ“ä½œï¼Œæ¯”å¦‚æ£€æŸ¥ä¿¡ç”¨ã€è¿æ¥æ•°æ®åº“ç­‰
        // è¿™ç»™äº†å¦ä¸€ä¸ªçº¿ç¨‹å¯ä¹˜ä¹‹æœºï¼
        std::this_thread::sleep_for(std::chrono::milliseconds(100));
        shared_account -= amount;
        std::cout << amount << " withdrawn. Remaining: " << shared_account << "\n";
    } else {
        std::cout << "Failed to withdraw " << amount << ". Not enough money.\n";
    }
}

int main() {
    std::cout << "Initial balance: " << shared_account << "\n";

    // ä½ å’Œå®¤å‹å‡ ä¹åŒæ—¶åœ¨ä¸åŒATMä¸Šæ“ä½œ
    std::thread you(withdrawMoney, 800);
    std::thread roommate(withdrawMoney, 800);

    you.join();
    roommate.join();

    std::cout << "Final balance: " << shared_account << "\n";
    return 0;
}
```

**ä¸€ä¸ªå¯èƒ½çš„é”™è¯¯è¾“å‡ºï¼š**
```
Initial balance: 1000
800 withdrawn. Remaining: 200
800 withdrawn. Remaining: -600 // ç³Ÿç³•ï¼ä½™é¢æˆè´Ÿæ•°äº†ï¼
Final balance: -600
```

**é—®é¢˜æ‰€åœ¨ï¼š**
ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ£€æŸ¥ `shared_account (1000) >= 800`ï¼Œæ¡ä»¶éƒ½æˆç«‹ã€‚ç„¶åéƒ½å»æ‰§è¡Œ `sleep`ï¼Œæœ€åéƒ½æ‰§è¡Œäº† `shared_account -= 800`ã€‚ç»“æœå°±æ˜¯è´¦æˆ·è¢«æ‰£äº†ä¸¤æ¬¡ 800ã€‚

è¿™å°±æ˜¯è‘—åçš„**æ•°æ®ç«äº‰**ã€‚å¹¶å‘ç¼–ç¨‹çš„æ ¸å¿ƒä¹‹ä¸€å°±æ˜¯è§£å†³è¿™ç§é—®é¢˜ã€‚

---

### ç¤ºä¾‹ 3ï¼šè§£å†³å¹¶å‘é—®é¢˜ - ä½¿ç”¨äº’æ–¥é” (Mutex)

ä¸ºäº†è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦è®©â€œæ£€æŸ¥è´¦æˆ·ä½™é¢å’Œæ‰£æ¬¾â€è¿™ä¸ªæ“ä½œå˜æˆä¸€ä¸ª**åŸå­æ“ä½œ**ï¼ˆä¸å¯åˆ†å‰²çš„æ•´ä½“ï¼‰ã€‚æˆ‘ä»¬ç»™ATMæœºåŠ ä¸€æŠŠé”ï¼ˆMutexï¼‰ã€‚

```cpp
#include <iostream>
#include <thread>
#include <mutex> // åŒ…å«äº’æ–¥é”åº“

int shared_account = 1000;
std::mutex atm_mutex; // åˆ›å»ºä¸€ä¸ªäº’æ–¥é”ï¼Œå°±åƒATMæœºçš„é‚£æŠŠé”

void safeWithdrawMoney(int amount) {
    // åœ¨è¿›å…¥ä¸´ç•ŒåŒºï¼ˆæ“ä½œå…±äº«æ•°æ®ï¼‰å‰ä¸Šé”
    atm_mutex.lock();

    // ä»è¿™é‡Œå¼€å§‹ï¼Œå…¶ä»–çº¿ç¨‹å¦‚æœä¹Ÿæƒ³lockï¼Œå°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æˆ‘unlock
    if (shared_account >= amount) {
        std::this_thread::sleep_for(std::chrono::milliseconds(100));
        shared_account -= amount;
        std::cout << amount << " withdrawn. Remaining: " << shared_account << "\n";
    } else {
        std::cout << "Failed to withdraw " << amount << ". Not enough money.\n";
    }

    // æ“ä½œå®Œæˆï¼Œé‡Šæ”¾é”ï¼Œè®©å…¶ä»–çº¿ç¨‹å¯ä»¥è¿›æ¥
    atm_mutex.unlock();
}

int main() {
    std::cout << "Initial balance: " << shared_account << "\n";

    std::thread you(safeWithdrawMoney, 800);
    std::thread roommate(safeWithdrawMoney, 800);

    you.join();
    roommate.join();

    std::cout << "Final balance: " << shared_account << "\n";
    return 0;
}
```

**ç°åœ¨è¾“å‡ºæ€»æ˜¯æ­£ç¡®çš„ï¼š**
```
Initial balance: 1000
800 withdrawn. Remaining: 200
Failed to withdraw 800. Not enough money.
Final balance: 200
```
æˆ–è€…
```
Initial balance: 1000
800 withdrawn. Remaining: 200
Failed to withdraw 800. Not enough money.
Final balance: 200
```

**æ›´æ¨èçš„å†™æ³•ï¼šä½¿ç”¨ std::lock_guard**
æ‰‹åŠ¨ `lock` å’Œ `unlock` å¾ˆéº»çƒ¦ï¼Œä¸”å®¹æ˜“å¿˜è®° unlockã€‚`std::lock_guard` æ˜¯ä¸€ä¸ªRAIIç±»ï¼Œåœ¨æ„é€ æ—¶è‡ªåŠ¨åŠ é”ï¼Œåœ¨ææ„æ—¶ï¼ˆå¦‚å‡½æ•°è¿”å›ã€æŠ›å‡ºå¼‚å¸¸ï¼‰è‡ªåŠ¨è§£é”ï¼Œéå¸¸å®‰å…¨ã€‚

```cpp
void verySafeWithdrawMoney(int amount) {
    // åˆ›å»ºlock_guardå¯¹è±¡æ—¶ï¼Œå®ƒè‡ªåŠ¨è°ƒç”¨atm_mutex.lock()
    std::lock_guard<std::mutex> guard(atm_mutex);

    // ä¸´ç•ŒåŒº
    if (shared_account >= amount) {
        std::this_thread::sleep_for(std::chrono::milliseconds(100));
        shared_account -= amount;
        std::cout << amount << " withdrawn. Remaining: " << shared_account << "\n";
    } else {
        // å‡½æ•°ç»“æŸæ—¶ï¼Œguardææ„ï¼Œè‡ªåŠ¨è°ƒç”¨atm_mutex.unlock()
        std::cout << "Failed to withdraw " << amount << ". Not enough money.\n";
    }
    // å‡½æ•°ç»“æŸï¼Œguardææ„ï¼Œè‡ªåŠ¨è§£é”
}
```

### æ€»ç»“ï¼šC++ å®ç°å¹¶å‘çš„åŸºæœ¬æ­¥éª¤

1.  **åŒ…å«å¤´æ–‡ä»¶**ï¼š`#include <thread>`, `#include <mutex>`
2.  **åˆ›å»ºçº¿ç¨‹å¯¹è±¡**ï¼š`std::thread t(func, arg1, arg2, ...)`
3.  **ç®¡ç†çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ**ï¼š
    *   `t.join()`: ç­‰å¾…çº¿ç¨‹ç»“æŸã€‚
    *   `t.detach()`: åˆ†ç¦»çº¿ç¨‹ï¼Œè®©å…¶è‡ªè¡Œè¿è¡Œï¼ˆä½¿ç”¨éœ€éå¸¸è°¨æ…ï¼‰ã€‚
4.  **ä¿æŠ¤å…±äº«æ•°æ®**ï¼šä½¿ç”¨ `std::mutex` å’Œ `std::lock_guard`ï¼ˆæˆ–å…¶ä»–é”ï¼‰æ¥é¿å…æ•°æ®ç«äº‰ã€‚
5.  **åŒæ­¥æ“ä½œ**ï¼šé™¤äº†äº’æ–¥é”ï¼ŒC++ è¿˜æä¾›äº† `<condition_variable>` å’Œ `<future>` ç­‰å·¥å…·æ¥è¿›è¡Œæ›´å¤æ‚çš„çº¿ç¨‹é—´åŒæ­¥å’Œé€šä¿¡ã€‚

è¿™å°±æ˜¯ C++ å®ç°å¹¶å‘ç¼–ç¨‹çš„åŸºç¡€ã€‚å®ƒç»™äº†ä½ å¼ºå¤§çš„åº•å±‚æ§åˆ¶èƒ½åŠ›ï¼Œä½†ä¹Ÿè¦æ±‚ç¨‹åºå‘˜ä»”ç»†åœ°å¤„ç†åŒæ­¥é—®é¢˜ã€‚
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTE4NDAxOTMyNDZdfQ==
-->